apiVersion: v1
kind: Namespace
metadata:
  name: pepr-system
  labels:
    pepr.dev: ''
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pepr-static-test
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pepr-static-test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pepr-static-test
subjects:
  - kind: ServiceAccount
    name: pepr-static-test
    namespace: pepr-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pepr-static-test
  namespace: pepr-system
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-static-test-api-path
  namespace: pepr-system
type: Opaque
data:
  value: >-
    ZjY5NTNhMzRlZjI2ZGU3NzVlYzBkZWRkOGUzOGFjYWVhM2Y0MDE1ZmQyNzg5ZTAyYTZlODYxZmVmMDQ2ODA1OA==
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-static-test-tls
  namespace: pepr-system
type: kubernetes.io/tls
data:
  tls.crt: >-
    LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tDQpNSUlDcWpDQ0FaS2dBd0lCQWdJQkFUQU5CZ2txaGtpRzl3MEJBUXNGQURBQU1CNFhEVEkxTURNd01URTNNakUwDQpNVm9YRFRJMk1ETXdNVEUzTWpFME1Wb3dBRENDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DDQpnZ0VCQUxwblRBQ2lKK2JtRXJPa05MMkd1c096TFU1OGE2SGFDL3N2UFYxR2MvQVdJdS91MFlFSEJ0YytiSXBhDQprb0JmOC9pNHZDaE1hbnZWdUF5RWNUMnJibEwwcEx0QWpVT0VVNHR5S2VJZTB1eDdwcnBiYUpNM1lySGFTeTlDDQpaNXhodjdUTTh6NzlTNFpqbjFrT3JSNStwTzgwSXN0MWU2cXZGalVROGJyK29JMGM2em9LTzNkcmY1KzRkN2NIDQpzUHE2OGlFTTBLd1JwQ1MyL3hhd0xaOW43WnZXa1pwQU9EMHd4aVA3UU1yOXE0UEt5YWVlWUs2Smx6d0tiN1BpDQpQbjdaOEVxVDRwRVM2bW5ITWUyN3hSbmxtc1p0SkJZc3ZMNndaN3gzUjUrTFNiN0RKY1JoNTBVOXROVjdjakF3DQprS2RiV2JYN1grQkQreHV4anZQeUpLTVI3WGtDQXdFQUFhTXZNQzB3S3dZRFZSMFJCQ1F3SW9JZ2NHVndjaTF6DQpkR0YwYVdNdGRHVnpkQzV3WlhCeUxYTjVjM1JsYlM1emRtTXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSDRGDQptK2RPSXZiV3NFWTBmdmMyUXAyRUhLMHFpS0lNRURhbWxyU0g4eGp5VjA1NlNBRE90TEhjLytZWHZSc0lyN2VODQpUWGp6dnV2WE1LT1lBM1J5VUR2Z3ZrMWtkY3FjYi95N2tCOGRSQ1VJTE1iUHRkZUxyRUNKRk1yeGRrR3cxNmdsDQpWLzRPdGx5dUpjSXFveGNFS0tGVDNoRjA4dFBTL0dEWWt5SFQ3a1ZWS0k3YnNLaUdKM1ZEQlZ2T2d6dFpDVCtwDQpZZ2Iza3dQelg3bmZzTHVGaEtOcHZaM1RLbWlpaEg5YjV5ZjZIVnVpQjBhL2k4SFV0cXM1SkRkdzB3QW9MM2E5DQo4U1RxTFFjaTBydVNWZFlFNlc2WFNqY0I1cVlwRVVsNkk3c3czN3JCelU4NTRUUkJ4Wlo4eThwMjlsTXVrS1RtDQp2TEpUaUcrWnBzeDVzQ1BhZStzPQ0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ0K
  tls.key: >-
    LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQ0KTUlJRXBBSUJBQUtDQVFFQXVtZE1BS0luNXVZU3M2UTB2WWE2dzdNdFRueHJvZG9MK3k4OVhVWno4QllpNys3Ug0KZ1FjRzF6NXNpbHFTZ0YveitMaThLRXhxZTlXNERJUnhQYXR1VXZTa3UwQ05RNFJUaTNJcDRoN1M3SHVtdWx0bw0Ka3pkaXNkcExMMEpubkdHL3RNenpQdjFMaG1PZldRNnRIbjZrN3pRaXkzVjdxcThXTlJEeHV2NmdqUnpyT2dvNw0KZDJ0L243aDN0d2V3K3JyeUlRelFyQkdrSkxiL0ZyQXRuMmZ0bTlhUm1rQTRQVERHSS90QXl2MnJnOHJKcDU1Zw0Kcm9tWFBBcHZzK0krZnRud1NwUGlrUkxxYWNjeDdidkZHZVdheG0wa0ZpeTh2ckJudkhkSG40dEp2c01seEdIbg0KUlQyMDFYdHlNRENRcDF0WnRmdGY0RVA3RzdHTzgvSWtveEh0ZVFJREFRQUJBb0lCQUFadXFSYytnVHo5QkhreA0KZWVadVgwU0FpdGd4Lys3U1hPWjZqMVlJSjlrSmtvUVFEQ2UxSzkzQ21ERkFCZDByTW5xTE9XYjBtQm9VMm1pSQ0KSzNZeTA3aEdHK2NnUjUra1VkTzJpVTUxdk5hUFA4WWZnR0RRSVBZOUw2bitVeC80MllvdUpsaXVtZXdWeFBwbw0KUUw0VUpiSGhiUy96S21UTjdPakE0RzZRK2M1VXVZbTZ5SktSQWtkMG9JRkx6REZHcmhING1SR3pIc1orcU1vNg0KdVhzMVphMzh0N2EvMnlHMjdCeE1xcHdwa1NYRllQQnYrbGNpbHJBVGk0ZEE5NE4xNm9XR2xSeEErc2pWMFVyWA0KakNhNk5BOXhLbDlyRlRlUnAwWVR0cnBxM04rdEI4bURwZHJwcEUvVEp3TXpMV2gxREx5bmo2dmQ1YkpkSzF6Nw0KTWNOZ1RRRUNnWUVBNXZ3cVU1Y3pTNWVobnJwN2IrNHk1ZnJBUUJxSkJwcjlLVXpUaEFOUk9WSHdIbEJoR2Qzbg0Kc3VSOXB5aC9zTldjMWZMclpSS29XM25pSmo2VUd4djEzQmxvbFhDYldrOXJBbmNreEJJYXZELy9JMGZPVjBtWQ0KSmZJWXNkTjhCU2cxd2dnMGJKMEhVbSs1L0h5R1ExcXFJQ3Z4V3NzTlkzNW80bjRDb1lyYlh6a0NnWUVBenBjbg0KQkd0R2lsbWFjalhaV0JPZTdseHlKRzMzdVNWRTNqd0ZqMmxqb3NHQnZLVTNKUHlEVmdLcjJpMTdEcndvR1RJVA0KbjU4cnJwU1JmbWJROTF3cDNrSmRGL0VWUHJ2VHhCTmpqa1dkblJSYkhxNWxIY2o5Y2xPdWVCL0NtVjZ6Q0ZKWQ0KQUE0MGpEcDJCK3BScDU0SDIxV1lHc1RIQnZrTUI2QW5BaldVd0VFQ2dZRUF0Q01ZUjFSMWxwQk1aT045L0k3Qg0KZHdXVkJPa3N6OC96ZTFBRTdNRkJpUGhUMFBCU3FiK2JRTEpkSkEyN2Q0Yy81c0twdll0TmJQbWkycnlXK0lWWA0KdWl5K21UeldpeG5BbEkyaVNKN3Q1cjNxRmZPY0Fnck04MXJZMDJYaEpJeDFVRHJoMTRxbStTMVUySW1zazc2VA0KU3IrNlhGcGF1S3NPMVFQOHZVcnpSbEVDZ1lFQWhNZXRzaTlvMVQ4bC8wWVEvWVVPMzFEWHBBWng4N082Z2NPKw0KSnlDcmcwNHdIcGxweWdIcVAvdlRqSlV5eEpPMmlnc2ZoYlorRXVVMlpqR2JHWUZJLzZ0VHZqR2JZQWpFNFA4OQ0KTzVJTzdZakp6L3h5elNRRGtkbXJCMVlTY3hUa3FQS1QwT1ZRYk5pZVNCUVlpMDBNNjdJbDR2NmFsU2E0enFYbQ0KcklyWG9vRUNnWUJOcW1OdEJoM3l3dlpYSDVHeUthRW8xOVVzSThTU2FmYUFmSGg2YVpNQ0RHNGJISFMrWVBNLw0KOWY0d255Nk5wWGg4S2FIRVJRYUl6cjQ1cVV0VmVjNUJiL2Z3Mkpoc1kxQlltUzFTQ29KT0w5R0ErNk83SmV2Qw0KdisrRnF2S3poR3QvZ3BZdUNNYWpXQ0Z2bEFqSjBPQ3F0bWFPR1NaZEU5STJ3VkhGVlhkSXVnPT0NCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tDQo=
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-static-test
  namespace: pepr-system
  annotations:
    pepr.dev/description: A test module for Pepr
  labels:
    app: pepr-static-test
    pepr.dev/controller: admission
    pepr.dev/uuid: static-test
spec:
  replicas: 2
  selector:
    matchLabels:
      app: pepr-static-test
      pepr.dev/controller: admission
  template:
    metadata:
      annotations:
        buildTimestamp: '1740849700719'
      labels:
        app: pepr-static-test
        pepr.dev/controller: admission
    spec:
      terminationGracePeriodSeconds: 5
      priorityClassName: system-node-critical
      serviceAccountName: pepr-static-test
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        - name: server
          image: pepr:dev
          imagePullPolicy: IfNotPresent
          args:
            - /app/node_modules/pepr/dist/controller.js
            - c47f3cd607c8c939d6b18bbe73998b8540b0d0586573117a2f78f6524a058483
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 256Mi
              cpu: 200m
            limits:
              memory: 512Mi
              cpu: 500m
          env:
            - name: PEPR_WATCH_MODE
              value: 'false'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: info
            - name: MY_CUSTOM_VAR
              value: example-value
            - name: ZARF_VAR
              value: '###ZARF_VAR_THING###'
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: api-path
              mountPath: /app/api-path
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-static-test-tls
        - name: api-path
          secret:
            secretName: pepr-static-test-api-path
        - name: module
          secret:
            secretName: pepr-static-test-module
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-static-test
  namespace: pepr-system
  labels:
    pepr.dev/controller: admission
spec:
  selector:
    app: pepr-static-test
    pepr.dev/controller: admission
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: pepr-static-test-watcher
  namespace: pepr-system
  labels:
    pepr.dev/controller: watcher
spec:
  selector:
    app: pepr-static-test-watcher
    pepr.dev/controller: watcher
  ports:
    - port: 443
      targetPort: 3000
---
apiVersion: v1
kind: Secret
metadata:
  name: pepr-static-test-module
  namespace: pepr-system
type: Opaque
data:
  module-c47f3cd607c8c939d6b18bbe73998b8540b0d0586573117a2f78f6524a058483.js.gz: >-
    H4sIAAAAAAAAE31Ta2scNxT9nl+haiGZAY28xpQYmTE1TtOaxrFx7YbWuEYrXe8qq5FUPWY7Gea/B2nssg2lHwTSfZxzueeo5x6Z9mr1GUSkEp6UgWtvHfg4nPTcI99WjvC6PTWVI9jwDjAZe64TME6ENU9qnTxfaWDfLae6tITWw19JeaiwA+fxHLXtmLtZiTURQmw6K5MGTHrwQVnD8JIu6SEmEoLwysUSO0O5Fs216Ml6dJ1ByRaGnfUysPuZheDtccAEO6uVGBowa2UgvzPdCxMOIJJXccAPZK4IbDRWAsOn7eExXdIlnkhuYWNKSjIcIo9KlHkxseZH761nWK2N9YDJDlYba7e3qgObIjtcEpFCtN0HvgKdoXkHwXEBbCyDUAk9ZhhPE+F6x4dwUYD2CgO7f5iIMkInCfK90iVCwPRsvPz98fzu19ury8ffzm4Yhr955zQ0RQ1M/ji7eT8nFovFy+Px9ueLjz8tFotMOW81sBFvj2QTICaHWb4joVOI4JEEDRFQ2ZmEHr1+jfbTwgPfTzfN9ig03K/Rm6aRsErrHwL4HjxbvkFNs+MqFoi0AhE18lZrmyLKO00BSXDaDh2YiBpTipowhAgdnogEB0aCESorVATBT0oDo/Sg0GerLPMQoK3LGDSuv2CSjFRCMfzn22KlDNS/+xdWHNyzvRj+nr6lR3iaikHhP20bWwM7BPScO75SWsWhevbxBrS2zey9bxwbVBYGPQuExD+9KFoUNnaH8okbZdYB7azfUjzVZPy0AcPU1EaiW1/xMBiBXHs68rzIakmA/nIc6goop9dW1vTCfHyxzTxzI6GzuKbvioyVqyeCZ0mvrcT1idrrDedFTHnl75zMl+p/AD/xKDbfToR05WgHkUseOc1Lqaf6JK8r0PxHL8unqyy5jw/1yauDgwUKNnkBl9w5ZdZ3Nx/aQrL3x+jnQDvuXn0FS1Fwn5cEAAA=
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pepr-static-test-store
  namespace: pepr-system
rules:
  - apiGroups:
      - pepr.dev
    resources:
      - peprstores
    resourceNames:
      - ''
    verbs:
      - create
      - get
      - patch
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pepr-static-test-store
  namespace: pepr-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pepr-static-test-store
subjects:
  - kind: ServiceAccount
    name: pepr-static-test-store
    namespace: pepr-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pepr-static-test-watcher
  namespace: pepr-system
  annotations:
    pepr.dev/description: A test module for Pepr
  labels:
    app: pepr-static-test-watcher
    pepr.dev/controller: watcher
    pepr.dev/uuid: static-test
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pepr-static-test-watcher
      pepr.dev/controller: watcher
  template:
    metadata:
      annotations:
        buildTimestamp: '1740849700719'
      labels:
        app: pepr-static-test-watcher
        pepr.dev/controller: watcher
    spec:
      terminationGracePeriodSeconds: 5
      serviceAccountName: pepr-static-test
      securityContext:
        runAsUser: 65532
        runAsGroup: 65532
        runAsNonRoot: true
        fsGroup: 65532
      containers:
        # - name: informer
        #   image: pepr-informer:dev
        #   imagePullPolicy: IfNotPresent
        #   command: ["./pepr-informer", "--server-address=:8080", "--nats-url=nats://nats-headless:4222"]
        #   resources:
        #     requests:
        #       memory: 128Mi
        #       cpu: 100m
        #     limits:
        #       memory: 128Mi
        #       cpu: 200m
        - name: watcher
          image: pepr:dev
          imagePullPolicy: IfNotPresent
          args:
            - /app/node_modules/pepr/dist/controller.js
            - c47f3cd607c8c939d6b18bbe73998b8540b0d0586573117a2f78f6524a058483
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3000
              scheme: HTTPS
            initialDelaySeconds: 10
          ports:
            - containerPort: 3000
          resources:
            requests:
              memory: 256Mi
              cpu: 200m
            limits:
              memory: 512Mi
              cpu: 500m
          securityContext:
            runAsUser: 65532
            runAsGroup: 65532
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tls-certs
              mountPath: /etc/certs
              readOnly: true
            - name: module
              mountPath: /app/load
              readOnly: true
          env:
            - name: PEPR_WATCH_MODE
              value: 'true'
            - name: PEPR_PRETTY_LOG
              value: 'false'
            - name: LOG_LEVEL
              value: info
            - name: MY_CUSTOM_VAR
              value: example-value
            - name: ZARF_VAR
              value: '###ZARF_VAR_THING###'
      volumes:
        - name: tls-certs
          secret:
            secretName: pepr-static-test-tls
        - name: module
          secret:
            secretName: pepr-static-test-module
